# Story 2.1: Core Business Logic

## Status
Approved

## Story
**As a** student enrolling in courses,
**I want** accurate course end date calculations that consider holidays and teacher availability,
**so that** I can plan my schedule and understand when my course will complete.

## Acceptance Criteria
1. Implement date calculation utilities that exclude holidays from course scheduling
2. Create teacher availability business logic with capacity management
3. Build course end date calculation API that considers holidays and teacher schedules
4. Add real-time availability updates via Supabase realtime
5. Implement comprehensive testing for all date calculation functions
6. Ensure calculations handle edge cases (weekends, holiday clusters, teacher unavailability)
7. API responses must include detailed schedule breakdown with actual class dates
8. Business logic must integrate with existing course and teacher data models

## Tasks / Subtasks
- [x] Task 1: Implement core date calculation utilities (AC: 1, 5, 6)
  - [x] Create `dateCalculations.ts` utility with holiday exclusion logic
  - [x] Implement `calculateCourseEndDate` function with holiday consideration
  - [x] Add `getHolidaysInRange` function for date range queries
  - [x] Create `isBusinessDay` function for holiday and weekend checking
  - [x] Add comprehensive unit tests for all utility functions
  - [x] Test edge cases: holiday clusters, weekend overlaps, leap years
- [x] Task 2: Create teacher availability business logic (AC: 2, 4, 8)
  - [x] Build `teacherAvailabilityLogic.ts` with capacity management
  - [x] Implement availability calculation considering time slots and student limits
  - [x] Add real-time updates using Supabase realtime subscriptions
  - [x] Create availability aggregation functions for calendar display
  - [x] Implement conflict detection for overlapping availabilities
  - [x] Add unit tests for availability logic and capacity calculations
- [x] Task 3: Build course end date calculation API endpoint (AC: 3, 7)
  - [x] Create `/api/calculate-end-date` endpoint with request validation
  - [x] Implement comprehensive course scheduling algorithm
  - [x] Generate complete class schedule with individual session dates
  - [x] Add proper authentication and authorization middleware
  - [x] Include holiday impact reporting in API responses
  - [x] Add API endpoint unit and integration tests
- [x] Task 4: Integration testing and edge case validation (AC: 5, 6)
  - [x] Create integration tests for end-to-end scheduling workflows
  - [x] Test complex scenarios: multiple holidays, teacher unavailability
  - [x] Validate real-time updates work correctly with concurrent users
  - [x] Performance testing for calculation-heavy operations
  - [x] Error handling tests for invalid date ranges and missing data

## Dev Notes

### Previous Story Insights
[Source: Story 1.2 completion]
- API foundation is complete with comprehensive TypeScript interfaces in `/src/types/api.ts`
- Authentication middleware available at `/src/lib/middleware/api-auth.ts` 
- Error handling utilities available at `/src/lib/utils/api-error-handler.ts`
- Validation schemas pattern established with Zod in `/src/lib/validators/api-schemas.ts`
- Database tables `holidays` and `teacher_availability` are available with proper RLS policies

### Data Models and Schema References
[Source: docs/architecture/02-data-models.md]

**Holidays Table Schema:**
```sql
CREATE TABLE holidays (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    date DATE NOT NULL,
    name VARCHAR(255) NOT NULL,
    year INTEGER NOT NULL,
    is_national BOOLEAN DEFAULT true,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

**Teacher Availability Schema:**
```sql
CREATE TABLE teacher_availability (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    teacher_id UUID NOT NULL REFERENCES teachers(id) ON DELETE CASCADE,
    day_of_week INTEGER NOT NULL CHECK (day_of_week >= 0 AND day_of_week <= 6),
    start_time TIME NOT NULL,
    end_time TIME NOT NULL,
    max_students INTEGER NOT NULL DEFAULT 10,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

**Enhanced Teachers Table:**
- `max_students_per_class INTEGER DEFAULT 10` - Default class capacity
- `calendar_settings JSONB DEFAULT '{}'` - Flexible scheduling preferences

### API Specifications
[Source: docs/architecture/04-api-design.md]

**Calculate End Date API - POST /api/calculate-end-date:**

Request Interface:
```typescript
interface CalculateEndDateRequest {
  startDate: string; // ISO date
  courseHours: number;
  weeklyClasses: number;
  teacherId: string;
  excludeHolidays?: boolean;
}
```

Response Interface:
```typescript
interface CalculateEndDateResponse {
  endDate: string; // ISO date
  totalWeeks: number;
  holidaysExcluded: string[]; // ISO dates
  actualClassDays: number;
  schedule: ClassSchedule[];
}

interface ClassSchedule {
  date: string; // ISO date
  startTime: string; // HH:MM
  endTime: string;   // HH:MM
  duration: number; // minutes
}
```

### Component Integration Requirements
[Source: docs/architecture/03-component-architecture.md]

**Date Calculation Utilities Location:** `src/utils/dateCalculations.ts`

Required Functions:
```typescript
export function calculateCourseEndDate(
  startDate: Date,
  courseHours: number,
  weeklyClasses: number,
  holidayDates: Date[]
): CourseSchedule;

export function getHolidaysInRange(
  startDate: Date,
  endDate: Date,
  holidays: Holiday[]
): Holiday[];

export function isBusinessDay(
  date: Date,
  holidays: Holiday[]
): boolean;
```

**Teacher Availability Logic Location:** `src/utils/teacherAvailabilityLogic.ts`

Required Functions:
```typescript
export function calculateAvailableSlots(
  teacherId: string,
  dateRange: { start: Date; end: Date },
  holidays: Holiday[]
): AvailableSlot[];

export function checkCapacityConflicts(
  slotId: string,
  requestedCapacity: number
): boolean;
```

### File Locations Based on Project Structure
[Source: docs/architecture/01-integration-strategy.md]
- **API Endpoints:** `/src/app/api/calculate-end-date/route.ts`
- **Utility Functions:** `/src/utils/dateCalculations.ts`, `/src/utils/teacherAvailabilityLogic.ts`
- **Type Definitions:** Extend existing `/src/types/api.ts`
- **Validation Schemas:** Extend existing `/src/lib/validators/api-schemas.ts`
- **Tests:** `/__tests__/utils/dateCalculations.test.ts`, `/__tests__/api/calculate-end-date.test.ts`

### Authentication and Authorization
[Source: docs/architecture/04-api-design.md]
- **Permission Level:** Authenticated users only (students, teachers, admins)
- **Middleware Integration:** Use existing `authMiddleware` from `/src/lib/middleware/api-auth.ts`
- **Rate Limiting:** 50 requests/minute per user (expensive calculation operations)

### Performance and Technical Constraints
[Source: docs/architecture/04-api-design.md]
- **Response Time Target:** <200ms for date calculations
- **Concurrent Users:** Support multiple simultaneous calculations
- **Holiday Query Optimization:** Use existing indexes on holidays(date) and holidays(year)
- **Real-time Integration:** Supabase realtime for availability updates
- **Caching Strategy:** Consider caching holiday data for current/next year

### Error Handling Standards
[Source: docs/architecture/04-api-design.md]

Standard Error Codes to Implement:
- `TEACHER_NOT_FOUND` - Teacher ID not found
- `NO_AVAILABILITY` - Teacher has no available time slots
- `HOLIDAY_CONFLICT` - Requested date conflicts with holiday
- `INVALID_DATE_RANGE` - Start date after end date
- `CAPACITY_EXCEEDED` - Time slot at maximum capacity
- `VALIDATION_ERROR` - Request data validation failed

HTTP Status Code Usage:
- 200 OK - Successful calculation
- 400 Bad Request - Invalid request data
- 401 Unauthorized - Authentication required
- 404 Not Found - Teacher not found
- 409 Conflict - Scheduling conflict

### Integration Context
[Source: docs/architecture/01-integration-strategy.md]
- **Supabase Client:** Use existing patterns from `/src/lib/supabase/server`
- **Error Tracking:** Integrate with existing Sentry setup
- **TypeScript Standards:** Strict typing required, no `any` types
- **Testing Framework:** Use existing Jest setup with API test utilities

### Testing Standards

**Test File Locations:**
- Unit tests: `/__tests__/utils/dateCalculations.test.ts`
- API tests: `/__tests__/api/calculate-end-date.test.ts`
- Integration tests: `/__tests__/integration/business-logic.test.ts`

**Testing Requirements:**
- Unit tests for all utility functions with 100% code coverage
- API endpoint testing including success, validation, and error scenarios
- Integration tests for complete workflows (enrollment with date calculation)
- Performance tests for calculation-heavy operations
- Edge case testing: leap years, holiday clusters, weekend handling
- Mock data for consistent test scenarios using existing test patterns

**Testing Frameworks:**
- Jest for unit and integration testing
- Existing API test utilities from `/__tests__/api/setup.ts`
- Supabase test client for database integration tests
- Mock factories for holiday and teacher availability data

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-07-22 | 1.0 | Initial story creation based on Phase 2 core logic requirements | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514)

### Implementation Summary
Successfully implemented comprehensive core business logic for course scheduling system with:

1. **Date Calculation Utilities** (`/src/utils/dateCalculations.ts`)
   - Holiday exclusion logic with business day validation
   - Course end date calculation with weekend and holiday skipping
   - Edge case handling for leap years, holiday clusters, and timezone considerations
   - Comprehensive utility functions for date manipulation and validation

2. **Teacher Availability Business Logic** (`/src/utils/teacherAvailabilityLogic.ts`)
   - Capacity management with conflict detection
   - Real-time updates via Supabase subscriptions
   - Calendar aggregation functions for display
   - Availability validation and overlap detection

3. **API Endpoint** (`/src/app/api/calculate-end-date/route.ts`)
   - Complete course scheduling algorithm with authentication
   - Comprehensive request/response validation
   - Integration with existing middleware and error handling
   - Detailed class schedule generation with teacher availability integration

4. **Comprehensive Testing Suite**
   - Unit tests for all utility functions (100% coverage)
   - API endpoint tests including authentication and validation scenarios
   - Integration tests for end-to-end workflows
   - Performance and edge case validation

### Debug Log References
- No critical issues encountered during implementation
- All tests passing with comprehensive edge case coverage
- Real-time subscription functionality validated
- Performance requirements met (<200ms response time)

### Completion Notes
- All acceptance criteria (AC 1-8) fully implemented
- Business logic integrates seamlessly with existing API foundation
- Comprehensive error handling with proper HTTP status codes
- Holiday and teacher availability data models utilized correctly
- Real-time updates implemented via Supabase realtime subscriptions

### File List
**New Files Created:**
- `/src/utils/dateCalculations.ts` - Core date calculation utilities
- `/src/utils/teacherAvailabilityLogic.ts` - Teacher availability business logic
- `/src/app/api/calculate-end-date/route.ts` - Course end date calculation API
- `/__tests__/utils/dateCalculations.test.ts` - Date utilities unit tests
- `/__tests__/utils/teacherAvailabilityLogic.test.ts` - Availability logic unit tests
- `/__tests__/api/calculate-end-date.test.ts` - API endpoint tests
- `/__tests__/integration/business-logic.test.ts` - Integration test suite

**Modified Files:**
- `/src/types/api.ts` - Extended with business logic types
- `/src/lib/validators/api-schemas.ts` - Added validation schemas for new endpoints

### Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-07-23 | 1.1 | Implementation completed - all tasks and subtasks finished | James (Dev Agent) |

### Status
Ready for Review

## QA Results
*This section will be populated by QA agent after implementation review*